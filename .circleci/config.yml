# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  win: circleci/windows@2.2.0
  rust: circleci/rust@1.6.0


# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  win-test:
    executor:
      name: win/default
      shell: powershell.exe
    steps:
      # - checkout
      # - run:
      #     name: Fetch rustup-init.exe
      #     command: Invoke-WebRequest https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-gnu/rustup-init.exe -OutFile rustup-init.exe
      # - run:
      #     name: Install rust
      #     command: .\rustup-init.exe --no-modify-path --default-host x86_64-pc-windows-gnu --default-toolchain stable --profile minimal -y
      - run:
          name: Install msys2
          command: >-
            (New-Object System.Net.WebClient).DownloadFile('https://github.com/msys2/msys2-installer/releases/download/nightly-x86_64/msys2-base-x86_64-latest.sfx.exe', 'msys2.exe') ;
            .\msys2.exe -y -oC:\ ;
            Remove-Item msys2.exe
      - run:
          name: Install msys2 dependencies
          command: pacman --noconfirm -S curl base-devel mingw-w64-x86_64-cfitsio mingw-w64-x86_64-pkg-config
          shell: C:/msys64/usr/bin/bash.exe -l

      - run:
          name: Run the tests
          command: |
            cd /c/Users/circleci/project &&
            PATH=/c/Users/circleci/.cargo/bin:/mingw64/bin:${PATH:-} MSYSTEM=MINGW64 CARGO_NET_GIT_FETCH_WITH_CLI=true cargo test -p fitsio
          shell: C:/msys64/usr/bin/bash.exe -l

  say-hello:
    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
    docker:
      - image: cimg/base:stable
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - run:
          name: "Say hello"
          command: "echo Hello, World!"

  test:
    parameters:
      version:
        type: string
    docker:
      - image: cimg/rust:<< parameters.version >>
    steps:
      - run:
          name: Install dependencies
          command: >-
            sudo apt-get update && sudo apt-get install --no-install-recommends -y \
              llvm-dev \
              libcfitsio-dev \
              pkg-config \
              libssl-dev \
              python3
      - checkout
      - run: 
          name: Run tests
          command: cargo test -p fitsio


# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  say-hello-workflow:
    jobs:
      # - test:
      #     matrix:
      #       parameters:
      #         version:
      #           - 1.58.1
      - win-test
